![image](https://github.com/Advaith-RN/pes_PhysicalDesignExploration/assets/77977360/e6303cef-2778-454f-8f6d-703a3794ea92)## LEF Extraction and Generation

**Place and Route (PnR) Process Overview:**

PnR is performed using an abstract view of GDS (Graphic Data System) files generated by Magic. This abstract view includes crucial information such as metal layers and pin placements. 
The PnR tool utilizes this abstract view, formally defined as LEF (Library Exchange Format) information, to facilitate interconnect routing, in coordination with routing guides generated during the PnR flow.

**LEF Information:**

1. **Technology LEF:**
   - Contains essential layer information, via specifications, and restricted Design Rule Check (DRC) rules for the technology.

2. **Cell LEF:**
   - Provides an abstract representation of standard cells.

**Guidelines for Standard Cell Set Generation from a PnR Perspective:**

- Input and output ports must align with the intersection of vertical and horizontal tracks.
- The width of the standard cell should be an odd multiple of the track pitch, while the height should be an odd multiple of the vertical track pitch.

These guidelines are essential to ensure the proper placement and routing of standard cells within the chip design.

View the track info at ```~/Desktop/work/tools/openlane_working_dir/pdks/sky130A/libs.tech/openlane/sky130_fd_sc_hd/tracks.info```.

![image](https://github.com/Advaith-RN/pes_PhysicalDesignExploration/assets/77977360/0a3589a9-d3c1-4b27-acd0-cb402ec4e75e)

In magic, you can also set the grid info with the following command. <br><br>
![image](https://github.com/Advaith-RN/pes_PhysicalDesignExploration/assets/77977360/c89ccab6-074a-4a3e-8556-3a4e63dacecd)

![image](https://github.com/Advaith-RN/pes_PhysicalDesignExploration/assets/77977360/f4d3e44e-64a5-4ba2-889f-ac700e0d6d8d)

From this, we can infer that:
- The ports A and Y are aligned along the tracks.
- The boundary takes up a 3x9 grid.

i.e. Both the conditions are met.

Now, to generate the LEF file:
- Execute ```save sky130_vsdinv.mag``` in the _tkcon_.
- ```magic -T sky130A.tch sky130_vsdinv.mag``` in the terminal will open the new saved layout.
- In the newly opened tkcon, execute ```lef write```. This will generate and lef file. <br><br>
![image](https://github.com/Advaith-RN/pes_PhysicalDesignExploration/assets/77977360/5d859ecd-8b68-4bc6-892c-ea551ca008ab)
![image](https://github.com/Advaith-RN/pes_PhysicalDesignExploration/assets/77977360/b6af3bc8-6c5d-4730-aef0-1894243fbb8c)

Use this generated lef file with the **picorv32a** design:
- Go the this folder: ```~/Desktop/work/tools/openlane_working_dir/openlane/designs/picorv32a/src```
- Copy the lef and other files and ensure the folder looks like this.
<br><br>
![image](https://github.com/Advaith-RN/pes_PhysicalDesignExploration/assets/77977360/427500d5-de5f-4d29-b44d-a36e0ec1238d)
- Also make sure to change the ```config.tcl``` file to include the lef file.
```
# Design
set ::env(DESIGN_NAME) "picorv32a"

set ::env(VERILOG_FILES) "./designs/picorv32a/src/picorv32a.v"
set ::env(SDC_FILE) "./designs/picorv32a/src/picorv32a.sdc"

set ::env(CLOCK_PERIOD) "10.000"
set ::env(CLOCK_PORT) "clk"


set ::env(CLOCK_NET) $::env(CLOCK_PORT)
set ::env(FP_CORE_UTIL) 65
set ::env(FP_IO_VMETAL) 4
set ::env(FP_IO_HMETAL) 3

set ::env(LIB_SYNTH) [glob $::env(OPENLANE_ROOT)/designs/$::env(DESIGN_NAME)/src/sky130_fd_sc_hd__typical.lib]
set ::env(LIB_FASTEST) [glob $::env(OPENLANE_ROOT)/designs/$::env(DESIGN_NAME)/src/sky130_fd_sc_hd__fast.lib]
set ::env(LIB_SYNTH) [glob $::env(OPENLANE_ROOT)/designs/$::env(DESIGN_NAME)/src/sky130_fd_sc_hd__typical.lib]
set ::env(LIB_SLOWEST) [glob $::env(OPENLANE_ROOT)/designs/$::env(DESIGN_NAME)/src/sky130_fd_sc_hd__slow.lib]

set ::env(EXTRA_LEFS) [glob $::env(OPENLANE_ROOT)/designs/$::env(DESIGN_NAME)/src/*.lef]

set filename $::env(OPENLANE_ROOT)/designs/$::env(DESIGN_NAME)/$::env(PDK)_$::env(STD_CELL_LIBRARY)_config.tcl
if { [file exists $filename] == 1} {
	source $filename
}
```
![image](https://github.com/Advaith-RN/pes_PhysicalDesignExploration/assets/77977360/70cc8387-2c4f-4419-8bad-588b27a03d0a)

Now, back in the Openlane container, reprep the design, run these commands and resynthesize.
```
% prep -design picorv32a -tag 19-09_15-28 -overwrite
% set lefs [glob $::env(DESIGN_DIR)/src/*.lef]
% add_lefs -src $lefs
% run_synthesis
```
![image](https://github.com/Advaith-RN/pes_PhysicalDesignExploration/assets/77977360/d01521c2-3c8d-4a5c-9318-3293f14e0536)

![image](https://github.com/Advaith-RN/pes_PhysicalDesignExploration/assets/77977360/2e49ced3-5d00-4d5f-83f1-22bfc82bea59)

![image](https://github.com/Advaith-RN/pes_PhysicalDesignExploration/assets/77977360/631107ab-bebb-4e52-99c5-a73f4d8c7d72)

After synthesizing, run the floorplan and placement.
```
init_floorplan
run_placement
```
Now, to view the placement diagram, execute this command in the placement directory in your most recent run.
```
magic -T /home/vsduser/Desktop/work/tools/openlane_working_dir/pdks/sky130A/libs.tech/magic/sky130A.tech lef read ../../tmp/merged.lef def read picorv32a.placement.def &
```
<br><br>
![image](https://github.com/Advaith-RN/pes_PhysicalDesignExploration/assets/77977360/b0d8dafd-8132-4b7f-8d68-4ecba548e6de)


![image](https://github.com/Advaith-RN/pes_PhysicalDesignExploration/assets/77977360/93f350fe-1cad-406b-bfba-300977ed0288)

Zooming into the design with ```z```, we can see the sky_vsdinv module.
![image](https://github.com/Advaith-RN/pes_PhysicalDesignExploration/assets/77977360/a63fde9f-8b2e-4e0b-aad5-59936bcb9734)






